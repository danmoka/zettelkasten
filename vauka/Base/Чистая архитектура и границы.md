09122022 1432
Tags: #z #dev

---
# Чистая архитектура и границы

## Моё видение эволюции ПО


### Начало

Рассмотрим конкретное приложение по хранению событий инцидентов. В данном приложении требуется создать систему предоставления отчетов.

На начальном этапе можно выделить крупные компоненты: пользовательский интерфейс, бизнес правила, БД. Все три компонента могут развиваться самостоятельно. При этом правила игры определяются бизнес правилами. Они заявляют о том, какие данные они принимают, обрабатывают и сохраняют.

Рассмотрим бизнес правила. На начальном этапе выделим горизонтальные слои:
- контроллеры (для получения/возвращения данных в нужном формате для пользовательского интерфейса)
- сервисы (это варианты использования, реализуют логику приложения)
- core (ядро приложения, реализует критические бизнес правила, которые не зависят от приложения, организации и т.д.)
- репозитории (это реализация шлюзов для общения с базой данных, использует ORM, SQL и т.д.)
Вертикальные слои (каждый горизонтальный слой разбивается дополнительно):
- слой для работы с инцидентами
- слой для работы с отчетами

Между слоями есть интерфейсы, которые позволяют направить зависимости в сторону устойчивости, например:
- В ядре есть интерфейс для подсчета процента по входным данным. В ядре есть класс, которые реализует данный интерфейс
- В сервисах есть интерфейс сервиса отчета. Сервис отчета реализует данный интерфейс, при этом используя интерфейс из ядра для подсчета процента критических инцидентов
- В контроллерах есть реализация API интерфейса, которая использует интерфейс сервиса отчета
- и т.д.

Таким образом, разбили систему на слои, настроили направление зависимостей.
Профит? Насколько я понимаю, сервис отчета (со всеми сложными правилами) может быть собран в отдельную библиотеку и подключаться на этапе сборки приложения. При изменении сервиса отчета нужно заново собрать только его библиотеку и подключить эту библиотеку в приложение. Почему? Ядро не меняется, ему без разницы, что там за сервис отчета. Для контроллера интерфейсы взаимодействия не изменяются. Возможно, будут заново собраны контроллеры отчета (точно будут, если меняется интерфейс сервиса). Суть: ядро - меняется редко, редко надо пересобирать сервисы и далее остальное, контроллеры меняются часто, но от них никто не зависит - ничего пересобирать не надо.

### Проблемы 

Данные разрослись, сервис отчета не вывозит построение отчета.
Решение:
- придумали, как ускорить генерацию отчета
- добавили новый сервис отчета
- при помощи внедрения зависимостей подменили старый сервис отчета на новый в контроллере
- контроллер даже можно не пересобирать, для него остается всё как раньше
- собрали приложение

### Проблемы 2

Данных стало ещё больше. Новый алгоритм генерации тоже не справляется. Более быстрый алгоритм придумать невозможно.
Решение:
- Выделим в отдельный компонент генерацию отчета (сервис отчета, некоторые функции из ядра)
- Данный компонент будет иметь аналогичное разбиение на слои
- Основное приложение определит правила общения с компонентом генерации отчета, компонент будет реализовывать эти правила
- В основном приложении выделим слой для общения с внешними агентами (внешний агент, например, это компонент генерации отчета)
- На этом слое выделим вертикальный слой - отчет. Данный слой будет общаться с внешним агентом генерации отчета

Профит? Компонент генерации отчета располагаем на отдельном сервере, добавляем на него мощностей. Таким образом, время генерации отчета уменьшается. Или можно генерировать отчеты заранее, каждые 10 минут, например. В зависимости от нужд (быстрая генерация, хранение миллиона отчетов) меняем конфигурацию сервиса.
Итог: между приложением хранения инцидентов и генерации отчетов проведена полная архитектурная граница. Переход был безболезненный, т.к. на ранних этапах были проведены неполные архитектурные границы, которые на первых этапах помогли улучшить решение, ускорить развертывание, а на поздних этапах вырвать из приложения хранения инцидентов кусок генерации отчетов (у нас не было кучи зависимостей, которые были бы разбросаны по всему коду).

---
### Zero-Links
- 

---
### Links
- [[Чистая архитектура и круги]]
- [[Независимость (архитектура)]]

---
### Outer links
- [[Чистая архитектура, Роберт Мартин]] (с. 220)