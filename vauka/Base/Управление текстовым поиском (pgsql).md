21092022 1537
Tags: #z #dev

---
# Управление текстовым поиском

Для полнотекстового поиска требуется преобразовать текст в tsvector, запрос в tsquery и выдать результаты в нужном порядке. Для этого в PostgreSQL есть все необходимые функции.

## Разбор текста

Используется функций to_tsvector, которая разбивает текст на фрагменты и подготавливает лексемы.

```sql
SELECT to_tsvector('english', 'a fat  cat sat on a mat - it ate a fat rats');
-- 'ate':9 'cat':3 'fat':2,11 'mat':7 'rat':12 'sat':4
-- отсутствуют слова a, it, -
```

## Разбор запроса

Используется функция to_tsquery нормализует лексемы, приводя их к явному виду. Используются операторы И, НЕ, ИЛИ, ПРЕДШЕСТВУЕТ.

```sql
SELECT to_tsquery('english', 'The & Fat & Rats');
-- 'fat' & 'rat'
-- the - удалено, окончание s - тоже
```

## Индексы GIN и GiST

Индекс GIN можно повесить на колонки, в которых хранятся tsvector.

```sql
CREATE INDEX test_col1_index ON test USING GIN (col1);
-- col1 типа tsvector
```

При поиске нескольких слов можно найти первое и исключить все строки, в которых нет дополнительных слов.

Индекс GiST допускает неточности, поэтому может работать медленно, но комбинируя индексы и разбивая данные на секции, можно добиться высокой скорости.

---
### Zero-Links
- 

---
### Links
- [[Полнотекстовый поиск (pgsql)]]